# é…å‡†å‚æ•°é…ç½®æŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº†ä¸åŒåœºæ™¯ä¸‹çš„æ¨èé…ç½®å‚æ•°ã€‚

## é…ç½®æ–¹å¼

### æ–¹å¼1: JSONé…ç½®æ–‡ä»¶ (æ¨è) â­

ä½¿ç”¨JSONæ–‡ä»¶ç®¡ç†é…å‡†å‚æ•°,æ”¯æŒå‘½ä»¤è¡ŒåŠ è½½:

```powershell
.\build\bin\Release\MIRegistration.exe --config ".\config\Rigid.json" --initial "åˆå§‹å˜æ¢.h5" "fixed.nrrd" "moving.nrrd" "è¾“å‡ºç›®å½•\"
```

**JSONé…ç½®ç¤ºä¾‹** (`config/Rigid.json`):
```json
{
    "transformType": "Rigid",
    "numberOfHistogramBins": 32,
    "samplingPercentage": 0.25,
    "learningRate": [2.0, 1.0, 0.5, 0.1, 0.05],
    "minimumStepLength": 1e-6,
    "numberOfIterations": [1000, 500, 250, 100, 0],
    "relaxationFactor": 0.5,
    "gradientMagnitudeTolerance": 1e-6,
    "numberOfLevels": 5,
    "shrinkFactors": [12, 8, 4, 2, 1],
    "smoothingSigmas": [4.0, 3.0, 2.0, 1.0, 1.0],
    "useStratifiedSampling": true,
    "randomSeed": 121212
}
```

**å…³é”®ç‰¹æ€§**:
- âœ… **åˆ†å±‚å­¦ä¹ ç‡**: `[2.0, 1.0, 0.5, 0.1, 0.05]` - ç²—ç³™å±‚å¤§æ­¥é•¿ï¼Œç²¾ç»†å±‚å°æ­¥é•¿
- âœ… æ¯å±‚ç‹¬ç«‹è¿­ä»£æ¬¡æ•°: `[1000, 500, 250, 100, 0]`
- âœ… ANTsé£æ ¼é‡‘å­—å¡”: 5å±‚ä»ç²—åˆ°ç²¾
- âœ… æ™ºèƒ½è·³è¿‡ç­–ç•¥: æœ€åä¸€å±‚è®¾ä¸º0è·³è¿‡å…¨åˆ†è¾¨ç‡ä¼˜åŒ–
- âœ… é‡‡æ ·ç™¾åˆ†æ¯”: 0.25 (25%é‡‡æ ·)ä»£æ›¿å›ºå®šé‡‡æ ·ç‚¹æ•°
- âœ… æ›´ä¸¥æ ¼æ”¶æ•›: minimumStepLength=1e-6, gradientMagnitudeTolerance=1e-6

### æ–¹å¼2: ä»£ç ä¸­ç›´æ¥è®¾ç½®

åœ¨`main.cpp`ä¸­ä¿®æ”¹å‚æ•°(ä¼ ç»Ÿæ–¹å¼):

```cpp
registration.SetNumberOfHistogramBins(50);
registration.SetNumberOfSpatialSamples(10000);
registration.SetMaximumStepLength(1.0);
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(200);
```

---

## æ¨èé…ç½® (åŸºäºå®æµ‹)

### ğŸš€ çº§è”é…å‡† Rigid + Affine (æœ€ä½³ç²¾åº¦,æ¨è) â­

**é€‚ç”¨åœºæ™¯**: éœ€è¦æœ€é«˜ç²¾åº¦çš„é…å‡†ä»»åŠ¡,è‡ªåŠ¨ä¸¤é˜¶æ®µæ‰§è¡Œ

```json
{
    "transformType": "RigidThenAffine",
    "numberOfHistogramBins": 32,
    "samplingPercentage": 0.1,
    "learningRate": [1.0, 1.0, 1.0, 1.0, 1.0],
    "minimumStepLength": 1e-6,
    "numberOfIterations": [1000, 500, 250, 100, 0],
    "numberOfLevels": 5,
    "shrinkFactors": [12, 8, 4, 2, 1],
    "smoothingSigmas": [4.0, 3.0, 2.0, 1.0, 1.0]
}
```

**é…ç½®æ–‡ä»¶**: `config/Rigid+Affine.json`

**å·¥ä½œæµç¨‹**:
1. **é˜¶æ®µ1**: åˆšä½“é…å‡† (6è‡ªç”±åº¦) - å¿«é€Ÿå…¨å±€å¯¹é½
2. **é˜¶æ®µ2**: ä»¿å°„é…å‡† (12è‡ªç”±åº¦) - åœ¨åˆšä½“åŸºç¡€ä¸Šç²¾ç»†è°ƒæ•´,æ”¯æŒç¼©æ”¾å’Œå‰ªåˆ‡

**æ€§èƒ½**: 150-180ç§’ (ä¸¤é˜¶æ®µæ€»å’Œ, 153Mä½“ç´ , 8çº¿ç¨‹)  
**ç²¾åº¦**: æé«˜  
**ä¼˜åŠ¿**: 
- âœ… **è‡ªåŠ¨åŒ–**ï¼šä¸€æ¬¡è¿è¡Œå®Œæˆä¸¤é˜¶æ®µ,æ— éœ€æ‰‹åŠ¨ä¿å­˜ä¸­é—´ç»“æœ
- âœ… **æœ€ä½³å®è·µ**ï¼šéµå¾ªANTsç­‰ä¸»æµå·¥å…·çš„é…å‡†ç­–ç•¥
- âœ… **ç¨³å®šæ€§å¼º**ï¼šåˆšä½“é˜¶æ®µæä¾›ç¨³å®šåˆå§‹åŒ–,é¿å…ä»¿å°„é˜¶æ®µé™·å…¥å±€éƒ¨æå°å€¼
- âœ… **ä¾¿æ·æ€§**ï¼šæ›¿ä»£æ‰‹åŠ¨ä¸¤æ­¥æ“ä½œ (`Rigid.json` â†’ ä¿å­˜ â†’ `Affine.json`)
- âœ… **æœ€ç»ˆè¾“å‡º**ï¼šè‡ªåŠ¨åˆå¹¶çš„ä»¿å°„å˜æ¢,åŒ…å«ä¸¤é˜¶æ®µç´¯ç§¯æ•ˆæœ

**ä½¿ç”¨ç¤ºä¾‹**:
```powershell
# å•æ¬¡è¿è¡Œå®Œæˆ Rigid + Affine
.\test_registration.ps1 fixed.nrrd moving.nrrd output\ `
    -config config\Rigid+Affine.json `
    -initial coarse.h5
```

---

### âš¡ ANTsé£æ ¼5å±‚é‡‘å­—å¡” - å•é˜¶æ®µ (å¿«é€Ÿ)

**é€‚ç”¨åœºæ™¯**: æœ‰ç²—é…å‡†åˆå§‹åŒ–çš„ç²¾é…å‡†,æˆ–ä»…éœ€åˆšä½“/ä»¿å°„å•é˜¶æ®µ

#### Rigid (åˆšä½“é…å‡†)
```json
{
    "transformType": "Rigid",
    "numberOfHistogramBins": 32,
    "samplingPercentage": 0.25,
    "learningRate": [2.0, 1.0, 0.5, 0.1, 0.05],
    "minimumStepLength": 1e-6,
    "numberOfIterations": [1000, 500, 250, 100, 0],
    "numberOfLevels": 5,
    "shrinkFactors": [12, 8, 4, 2, 1],
    "smoothingSigmas": [4.0, 3.0, 2.0, 1.0, 1.0]
}
```

**é…ç½®æ–‡ä»¶**: `config/Rigid.json`  
**æ€§èƒ½**: 65-80ç§’ (153Mä½“ç´ , 8çº¿ç¨‹)  
**ç²¾åº¦**: é«˜  

#### Affine (ä»¿å°„é…å‡†)
```json
{
    "transformType": "Affine",
    "numberOfHistogramBins": 32,
    "samplingPercentage": 0.1,
    "learningRate": [1.0, 1.0, 1.0, 1.0, 1.0],
    "minimumStepLength": 1e-6,
    "numberOfIterations": [1000, 500, 250, 100, 0],
    "numberOfLevels": 5,
    "shrinkFactors": [12, 8, 4, 2, 1],
    "smoothingSigmas": [4.0, 3.0, 2.0, 1.0, 1.0]
}
```

**é…ç½®æ–‡ä»¶**: `config/Affine.json`  
**æ€§èƒ½**: 90-110ç§’ (153Mä½“ç´ , 8çº¿ç¨‹)  
**æ³¨æ„**: éœ€è¦è‰¯å¥½çš„åˆå§‹åŒ–(å¦‚å…ˆç”¨Rigidé…å‡†)

**ä¼˜åŠ¿**: 
- **åˆ†å±‚å­¦ä¹ ç‡**: ç²—ç³™å±‚çº§(12x, 8x)ä½¿ç”¨å¤§æ­¥é•¿(2.0, 1.0)æå¿«æ”¶æ•›
- ç²¾ç»†å±‚çº§(4x, 2x)ä½¿ç”¨å°æ­¥é•¿(0.5, 0.1)é¿å…è¿‡å†²
- è·³è¿‡å…¨åˆ†è¾¨ç‡ä¼˜åŒ–èŠ‚çœå¤§é‡æ—¶é—´
- æ—©æœŸæ”¶æ•›è‡ªåŠ¨åœæ­¢,ä¸æµªè´¹è¿­ä»£
- æ›´ä¸¥æ ¼çš„æ”¶æ•›é˜ˆå€¼(1e-6)ç¡®ä¿ç²¾åº¦

---

## ä¼ ç»Ÿé…ç½®ç¤ºä¾‹ (ä»£ç æ–¹å¼)

### 1. é»˜è®¤é…ç½® (é€šç”¨)

é€‚ç”¨äºå¤§å¤šæ•°MRI-CTé…å‡†åœºæ™¯:

```cpp
registration.SetNumberOfHistogramBins(50);
registration.SetNumberOfSpatialSamples(10000);
registration.SetMaximumStepLength(1.0);
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(200);
```

**é¢„æœŸè€—æ—¶**: 2-5åˆ†é’Ÿ  
**é€‚ç”¨åœºæ™¯**: 256Â³å·¦å³çš„æ ‡å‡†åŒ»å­¦å›¾åƒ  
**æ³¨æ„**: ä¸å¦‚ANTs 5å±‚é‡‘å­—å¡”ç­–ç•¥å¿«

---

### 2. å¿«é€Ÿé…å‡† (ä½ç²¾åº¦)

é€‚ç”¨äºé¢„è§ˆæˆ–åˆæ­¥é…å‡†:

```cpp
registration.SetNumberOfHistogramBins(30);
registration.SetNumberOfSpatialSamples(5000);
registration.SetMaximumStepLength(2.0);
registration.SetMinimumStepLength(0.01);
registration.SetNumberOfIterations(100);
```

**é¢„æœŸè€—æ—¶**: 30ç§’-1åˆ†é’Ÿ  
**ç²¾åº¦**: ä¸­ç­‰,å¯èƒ½éœ€è¦åç»­ç²¾é…å‡†

---

### 3. é«˜ç²¾åº¦é…å‡†

é€‚ç”¨äºéœ€è¦é«˜ç²¾åº¦çš„ç ”ç©¶åœºæ™¯:

```cpp
registration.SetNumberOfHistogramBins(100);
registration.SetNumberOfSpatialSamples(50000);
registration.SetMaximumStepLength(0.5);
registration.SetMinimumStepLength(0.0001);
registration.SetNumberOfIterations(500);
```

**é¢„æœŸè€—æ—¶**: 10-20åˆ†é’Ÿ  
**ç²¾åº¦**: é«˜,é€‚åˆæœ€ç»ˆé…å‡†

---

### 4. å¤§å›¾åƒé…å‡† (512Â³+)

```cpp
registration.SetNumberOfHistogramBins(50);
registration.SetNumberOfSpatialSamples(100000);  // å¢åŠ é‡‡æ ·
registration.SetMaximumStepLength(1.0);
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(300);
```

**é¢„æœŸè€—æ—¶**: 15-30åˆ†é’Ÿ  
**è¯´æ˜**: å¤§å›¾åƒéœ€è¦æ›´å¤šé‡‡æ ·ç‚¹ä¿è¯è¦†ç›–

---

### 5. å°å›¾åƒé…å‡† (128Â³-)

```cpp
registration.SetNumberOfHistogramBins(30);
registration.SetNumberOfSpatialSamples(3000);    // å‡å°‘é‡‡æ ·
registration.SetMaximumStepLength(1.0);
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(150);
```

**é¢„æœŸè€—æ—¶**: 30ç§’-1åˆ†é’Ÿ

---

### 6. å¤šæ¨¡æ€é…å‡† (MRI-CT)

```cpp
registration.SetNumberOfHistogramBins(80);       // å¢åŠ bins
registration.SetNumberOfSpatialSamples(20000);
registration.SetMaximumStepLength(0.5);          // ä¿å®ˆæ­¥é•¿
registration.SetMinimumStepLength(0.0005);
registration.SetNumberOfIterations(300);
```

**è¯´æ˜**: å¤šæ¨¡æ€å›¾åƒå¯¹æ¯”åº¦å·®å¼‚å¤§,éœ€è¦æ›´ç»†è‡´çš„ç›´æ–¹å›¾

---

### 7. åŒæ¨¡æ€é…å‡† (MRI-MRI, CT-CT)

```cpp
registration.SetNumberOfHistogramBins(30);       // å¯ä»¥è¾ƒå°‘
registration.SetNumberOfSpatialSamples(10000);
registration.SetMaximumStepLength(1.5);          // å¯ä»¥æ›´æ¿€è¿›
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(150);
```

**è¯´æ˜**: åŒæ¨¡æ€å›¾åƒç›¸ä¼¼åº¦é«˜,æ”¶æ•›è¾ƒå¿«

---

## å‚æ•°è¯´æ˜

### NumberOfHistogramBins (ç›´æ–¹å›¾Binsæ•°)
- **ä½œç”¨**: æ§åˆ¶æ¦‚ç‡å¯†åº¦ä¼°è®¡çš„ç²¾ç»†åº¦
- **èŒƒå›´**: 20-200
- **å»ºè®®**: 
  - ä½å¯¹æ¯”åº¦: 50-100
  - é«˜å¯¹æ¯”åº¦: 20-50
- **å½±å“**: 
  - è¿‡å°: ä¸¢å¤±ä¿¡æ¯
  - è¿‡å¤§: è®¡ç®—æ…¢,å¯èƒ½å™ªå£°æ•æ„Ÿ

### NumberOfSpatialSamples (ç©ºé—´é‡‡æ ·ç‚¹æ•°)
- **ä½œç”¨**: æ§åˆ¶å‚ä¸è®¡ç®—çš„ä½“ç´ æ•°é‡
- **èŒƒå›´**: 1000-100000
- **å»ºè®®**:
  - å¿«é€Ÿé¢„è§ˆ: 3000-5000
  - æ ‡å‡†é…å‡†: 10000-20000
  - é«˜ç²¾åº¦: 50000+
- **å½±å“**:
  - è¿‡å°: ä¸ç¨³å®š,å¯èƒ½ä¸æ”¶æ•›
  - è¿‡å¤§: è®¡ç®—æ…¢

### MaximumStepLength (æœ€å¤§æ­¥é•¿)
- **ä½œç”¨**: åˆå§‹æœç´¢æ­¥é•¿
- **èŒƒå›´**: 0.1-5.0
- **å»ºè®®**:
  - åˆå§‹ä½ç½®å¥½: 0.5-1.0
  - åˆå§‹ä½ç½®å·®: 1.0-2.0
  - ç²¾ç»†è°ƒæ•´: 0.1-0.5
- **å•ä½**: ä¸å˜æ¢å‚æ•°ç›¸å…³
  - å¹³ç§»å‚æ•°: mm
  - æ—‹è½¬å‚æ•°: å¼§åº¦

### MinimumStepLength (æœ€å°æ­¥é•¿)
- **ä½œç”¨**: æ”¶æ•›é˜ˆå€¼
- **èŒƒå›´**: 0.00001-0.1
- **å»ºè®®**:
  - å¿«é€Ÿé…å‡†: 0.01
  - æ ‡å‡†é…å‡†: 0.001
  - é«˜ç²¾åº¦: 0.0001

### NumberOfIterations (æœ€å¤§è¿­ä»£æ¬¡æ•°)
- **ä½œç”¨**: é˜²æ­¢æ— é™å¾ªç¯
- **èŒƒå›´**: 50-1000
- **å»ºè®®**:
  - å¿«é€Ÿé…å‡†: 50-100
  - æ ‡å‡†é…å‡†: 150-300
  - é«˜ç²¾åº¦: 300-500
- **è¯´æ˜**: é€šå¸¸ä¼šå› å…¶ä»–æ”¶æ•›æ¡ä»¶æå‰åœæ­¢

---

## è°ƒå‚å»ºè®®æµç¨‹

### ç¬¬ä¸€æ­¥: ä½¿ç”¨é»˜è®¤å‚æ•°æµ‹è¯•

```cpp
// ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œä¸€æ¬¡
registration.SetNumberOfHistogramBins(50);
registration.SetNumberOfSpatialSamples(10000);
registration.SetMaximumStepLength(1.0);
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(200);
```

è§‚å¯Ÿ:
1. æ˜¯å¦æ”¶æ•›?
2. æ”¶æ•›é€Ÿåº¦å¦‚ä½•?
3. æœ€ç»ˆç»“æœç²¾åº¦?

### ç¬¬äºŒæ­¥: æ ¹æ®ç»“æœè°ƒæ•´

#### å¦‚æœä¸æ”¶æ•›:
- å¢åŠ `NumberOfSpatialSamples` â†’ 20000
- å¢åŠ `MaximumStepLength` â†’ 2.0
- å¢åŠ `NumberOfIterations` â†’ 300

#### å¦‚æœæ”¶æ•›å¤ªæ…¢:
- å¢åŠ `MaximumStepLength` â†’ 1.5
- å‡å°‘`NumberOfSpatialSamples` â†’ 5000
- è°ƒæ•´`RelaxationFactor` â†’ 0.6

#### å¦‚æœç²¾åº¦ä¸å¤Ÿ:
- å¢åŠ `NumberOfHistogramBins` â†’ 80
- å¢åŠ `NumberOfSpatialSamples` â†’ 20000
- å‡å°`MinimumStepLength` â†’ 0.0005

#### å¦‚æœé€Ÿåº¦å¤ªæ…¢:
- å‡å°‘`NumberOfSpatialSamples` â†’ 5000
- å‡å°‘`NumberOfHistogramBins` â†’ 30
- å‡å°‘`NumberOfIterations` â†’ 100

### ç¬¬ä¸‰æ­¥: ç²¾ç»†è°ƒä¼˜

è®°å½•æ¯ç»„å‚æ•°çš„:
- æœ€ç»ˆåº¦é‡å€¼
- æ”¶æ•›è¿­ä»£æ¬¡æ•°
- æ€»è€—æ—¶
- è§†è§‰è¯„ä¼°ç»“æœ

é€‰æ‹©æœ€ä½³å¹³è¡¡ç‚¹ã€‚

---

## ä»£ç æ¨¡æ¿

åœ¨`main.cpp`ä¸­ä¿®æ”¹å‚æ•°çš„ä½ç½®:

```cpp
// åˆ›å»ºé…å‡†å¯¹è±¡
ImageRegistration registration;

// è®¾ç½®å›¾åƒ
registration.SetFixedImage(fixedReader->GetOutput());
registration.SetMovingImage(movingReader->GetOutput());

// ============= åœ¨è¿™é‡Œä¿®æ”¹å‚æ•° =============
registration.SetNumberOfHistogramBins(50);
registration.SetNumberOfSpatialSamples(10000);
registration.SetMaximumStepLength(1.0);
registration.SetMinimumStepLength(0.001);
registration.SetNumberOfIterations(200);
// ========================================

// æ‰§è¡Œé…å‡†
registration.Update();
```

---

## æ•…éšœæ’é™¤é€ŸæŸ¥è¡¨

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|---------|---------|
| ä¸æ”¶æ•› | é‡‡æ ·å¤ªå°‘ | å¢åŠ samplesåˆ°20000 |
| æ”¶æ•›æ…¢ | æ­¥é•¿å¤ªå° | å¢åŠ max_stepåˆ°2.0 |
| ç²¾åº¦ä½ | Binså¤ªå°‘ | å¢åŠ binsåˆ°80 |
| é€Ÿåº¦æ…¢ | é‡‡æ ·å¤ªå¤š | å‡å°‘samplesåˆ°5000 |
| éœ‡è¡ | æ­¥é•¿å¤ªå¤§ | å‡å°max_stepåˆ°0.5 |
| å±€éƒ¨æå€¼ | åˆå§‹åŒ–å·® | æ‰‹åŠ¨åˆå§‹åŒ–æˆ–ç²—é…å‡† |

---

## JSONé…ç½®å‚æ•°è¯¦è§£

### åŸºæœ¬å‚æ•°

#### transformType
- **å€¼**: "Rigid" æˆ– "Affine"
- **è¯´æ˜**: å˜æ¢ç±»å‹
  - Rigid: 6å‚æ•°åˆšä½“å˜æ¢(æ—‹è½¬+å¹³ç§»)
  - Affine: 12å‚æ•°ä»¿å°„å˜æ¢(æ—‹è½¬+å¹³ç§»+ç¼©æ”¾+å‰ªåˆ‡)

#### numberOfHistogramBins
- **å€¼**: 20-100 (æ•´æ•°)
- **æ¨è**: 32 (ANTsé£æ ¼)
- **è¯´æ˜**: äº’ä¿¡æ¯ç›´æ–¹å›¾binsæ•°,å½±å“æ¦‚ç‡å¯†åº¦ä¼°è®¡ç²¾åº¦

#### samplingPercentage
- **å€¼**: 0.01-1.0 (å°æ•°)
- **æ¨è**: 0.25 (25%é‡‡æ ·,ç²¾åº¦ä¸é€Ÿåº¦å¹³è¡¡)
- **è¯´æ˜**: éšæœºé‡‡æ ·ä½“ç´ ç™¾åˆ†æ¯”,ä»£æ›¿å›ºå®šé‡‡æ ·ç‚¹æ•°
- **ä¼˜åŠ¿**: è‡ªåŠ¨é€‚åº”ä¸åŒå¤§å°å›¾åƒ
- **å¹³è¡¡**: 
  - 0.1 (10%): æ›´å¿«ä½†å¯èƒ½ä¸å¤Ÿç¨³å®š
  - 0.25 (25%): æ¨è,ç»Ÿè®¡æ€§å¥½
  - 0.5 (50%): ç²¾åº¦é«˜ä½†é€Ÿåº¦æ…¢

### ä¼˜åŒ–å™¨å‚æ•°

#### learningRate
- **ç±»å‹**: 
  - **å•ä¸€å€¼**: `0.1` (æ‰€æœ‰å±‚ä½¿ç”¨ç›¸åŒå­¦ä¹ ç‡)
  - **åˆ†å±‚æ•°ç»„**: `[2.0, 1.0, 0.5, 0.1, 0.05]` â­ **æ¨è**
- **æ¨èé…ç½®**:
  - ANTs 5å±‚é‡‘å­—å¡”: `[2.0, 1.0, 0.5, 0.1, 0.05]`
  - ä¼ ç»Ÿå•ä¸€å€¼: `0.1` (ä¿å®ˆä½†å¯èƒ½è¾ƒæ…¢)
- **åˆ†å±‚å­¦ä¹ ç‡åŸç†**:
  - **ç²—ç³™å±‚çº§** (12x, 8x): é«˜æ–¯å¹³æ»‘åèƒ½é‡æ›²é¢æ¥è¿‘å‡¸å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨**å¤§æ­¥é•¿**ï¼ˆ2.0, 1.0ï¼‰å¿«é€Ÿé€¼è¿‘å…¨å±€æœ€ä¼˜
  - **ç²¾ç»†å±‚çº§** (4x, 2x, 1x): å…¨åˆ†è¾¨ç‡ä¸‹å­˜åœ¨å¤§é‡å±€éƒ¨æå°å€¼ï¼Œéœ€è¦**å°æ­¥é•¿**ï¼ˆ0.5, 0.1, 0.05ï¼‰é¿å…è¿‡å†²
- **å®éªŒè¯æ®**:
  - å­¦ä¹ ç‡ 2.0 åœ¨ç²—ç³™å±‚ï¼ˆLevel 1-3ï¼‰è·å¾—æœ€é«˜äº’ä¿¡æ¯å€¼
  - å­¦ä¹ ç‡ 2.0 åœ¨ç²¾ç»†å±‚ï¼ˆLevel 4ï¼‰å‡ºç°**è¿‡å†²ç°è±¡**ï¼šè·³è¿‡æœ€ä¼˜ç‚¹å¯¼è‡´MIå€¼åè€Œé™ä½
  - åˆ†å±‚ç­–ç•¥å…¼é¡¾é€Ÿåº¦ï¼ˆç²—ç³™å±‚å¿«é€Ÿæ”¶æ•›ï¼‰å’Œç²¾åº¦ï¼ˆç²¾ç»†å±‚ç¨³å®šä¼˜åŒ–ï¼‰

**JSONé…ç½®ç¤ºä¾‹**:
```json
{
    "learningRate": [2.0, 1.0, 0.5, 0.1, 0.05],  // åˆ†å±‚å­¦ä¹ ç‡
    "numberOfLevels": 5,
    "shrinkFactors": [12, 8, 4, 2, 1]
}
```

**å‘åå…¼å®¹**: ä»æ”¯æŒå•ä¸€å€¼ `"learningRate": 0.1`ï¼Œå°†è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰å±‚çº§ã€‚

#### minimumStepLength
- **å€¼**: 1e-8 åˆ° 1e-3
- **æ¨è**: 1e-6 (æ›´ä¸¥æ ¼,ç²¾åº¦æ›´é«˜)
- **è¯´æ˜**: æ”¶æ•›é˜ˆå€¼,æ­¥é•¿å°äºæ­¤å€¼æ—¶åœæ­¢

#### numberOfIterations
- **ç±»å‹**: æ•´æ•°æ•°ç»„ `[level0, level1, ...]`
- **æ¨è**: `[1000, 500, 250, 100, 0]` (ANTs 5å±‚)
- **è¯´æ˜**: æ¯å±‚é‡‘å­—å¡”çš„æœ€å¤§è¿­ä»£æ¬¡æ•°
- **æŠ€å·§**: 
  - æœ€åä¸€å±‚è®¾ä¸º0å¯è·³è¿‡å…¨åˆ†è¾¨ç‡ä¼˜åŒ–
  - å®é™…è¿­ä»£æ¬¡æ•°é€šå¸¸å› æ—©æœŸæ”¶æ•›è€Œæ›´å°‘

#### relaxationFactor
- **å€¼**: 0.3-0.9
- **æ¨è**: 0.5
- **è¯´æ˜**: æ­¥é•¿è¡°å‡å› å­,æ¯æ¬¡è¿­ä»£æ­¥é•¿ *= relaxationFactor

#### gradientMagnitudeTolerance
- **å€¼**: 1e-8 åˆ° 1e-3
- **æ¨è**: 1e-6 (æ›´ä¸¥æ ¼)
- **è¯´æ˜**: æ¢¯åº¦å¤§å°æ”¶æ•›é˜ˆå€¼

### å¤šåˆ†è¾¨ç‡å‚æ•°

#### numberOfLevels
- **å€¼**: 1-7 (æ•´æ•°)
- **æ¨è**: 5 (ANTsé£æ ¼)
- **è¯´æ˜**: é‡‘å­—å¡”å±‚æ•°

#### shrinkFactors
- **ç±»å‹**: æ•´æ•°æ•°ç»„ `[level0, level1, ...]`
- **æ¨è**: `[12, 8, 4, 2, 1]` (ANTs 5å±‚)
- **è¯´æ˜**: æ¯å±‚å›¾åƒä¸‹é‡‡æ ·å› å­
- **æŠ€å·§**: 
  - 12x/8xç²—ç³™å±‚éå¸¸å¿«(å›¾åƒåªæœ‰å‡ åƒä½“ç´ )
  - 1x = å…¨åˆ†è¾¨ç‡

#### smoothingSigmas
- **ç±»å‹**: æµ®ç‚¹æ•°ç»„ `[level0, level1, ...]` (å•ä½: mm)
- **æ¨è**: `[4.0, 3.0, 2.0, 1.0, 1.0]`
- **è¯´æ˜**: æ¯å±‚å›¾åƒé«˜æ–¯å¹³æ»‘æ ‡å‡†å·®
- **ä½œç”¨**: æŠ‘åˆ¶å™ªå£°,æ‰©å¤§æ”¶æ•›åŸŸ

### é‡‡æ ·å‚æ•°

#### useStratifiedSampling
- **å€¼**: true æˆ– false
- **æ¨è**: true
- **è¯´æ˜**: ä½¿ç”¨åˆ†å±‚é‡‡æ ·ç¡®ä¿ç©ºé—´åˆ†å¸ƒå‡åŒ€

#### randomSeed
- **å€¼**: ä»»æ„æ•´æ•°
- **æ¨è**: 121212
- **è¯´æ˜**: éšæœºæ•°ç§å­,ç¡®ä¿ç»“æœå¯é‡å¤

---

## ANTsç­–ç•¥æ·±åº¦è§£æ

### ä¸ºä»€ä¹ˆ5å±‚é‡‘å­—å¡”è¿™ä¹ˆå¿«?

1. **æç²—ç³™å±‚çº§(12x, 8x)**
   - 12xä¸‹é‡‡æ ·: 153Mä½“ç´  â†’ **88Kä½“ç´ ** (1736å€ç¼©å‡)
   - 8xä¸‹é‡‡æ ·: 153Mä½“ç´  â†’ **298Kä½“ç´ ** (513å€ç¼©å‡)
   - **ç»“æœ**: è¿™ä¸¤å±‚åªéœ€å‡ ç§’é’Ÿ

2. **æ—©æœŸæ”¶æ•›**
   - ä¼˜åŒ–å™¨æ™ºèƒ½æ£€æµ‹æ”¶æ•›
   - ç²—ç³™å±‚çº§é€šå¸¸20æ¬¡è¿­ä»£å†…æ”¶æ•›
   - å°½ç®¡é…ç½®äº†1000/500æ¬¡,å®é™…ä¸ä¼šç”¨å®Œ

3. **è·³è¿‡å…¨åˆ†è¾¨ç‡(1x)**
   - è®¾ç½® `numberOfIterations[4] = 0`
   - åªåšåˆå§‹åŒ–,ä¸è¿­ä»£ä¼˜åŒ–
   - **èŠ‚çœ**: å…¨åˆ†è¾¨ç‡ä¼˜åŒ–é€šå¸¸éœ€è¦100+ç§’

4. **æ¸è¿›å¼ä¼˜åŒ–**
   - ç²—ç³™å±‚å¿«é€Ÿæ‰¾åˆ°å¤§è‡´ä½ç½®
   - ä¸­é—´å±‚(4x, 2x)ç²¾ç»†è°ƒæ•´
   - å…¨åˆ†è¾¨ç‡å±‚ç›´æ¥ä½¿ç”¨2xç»“æœ

### ä½•æ—¶ä½¿ç”¨ANTsç­–ç•¥?

âœ… **é€‚åˆ**:
- æœ‰ç²—é…å‡†åˆå§‹åŒ–
- éœ€è¦æè‡´é€Ÿåº¦
- å¤§å›¾åƒ(512Â³+)
- å¤šæ¬¡é…å‡†ä»»åŠ¡

âŒ **ä¸é€‚åˆ**:
- æ— åˆå§‹åŒ–(ä»å¤´é…å‡†)
- éœ€è¦æœ€é«˜ç²¾åº¦(ç”¨ä¼ ç»Ÿ3å±‚+æ›´å¤šè¿­ä»£)

### å¦‚ä½•è°ƒæ•´ANTså‚æ•°?

**åŠ å¿«é€Ÿåº¦**:
- å¢å¤§ç²—ç³™å±‚çº§: `[16, 12, 8, 4, 2]`
- å‡å°‘bins: 24 æˆ– 16
- å‡å°‘é‡‡æ ·: 0.15 (15%)

**æé«˜ç²¾åº¦**:
- ä¿ç•™1xå±‚ä¼˜åŒ–: `[1000, 500, 250, 100, 50]`
- å¢åŠ bins: 50
- å¢åŠ é‡‡æ ·: 0.35 (35%)
- æ›´ä¸¥æ ¼æ”¶æ•›: minimumStepLength=1e-7

---

## å±€éƒ¨é…å‡†: Mask(æ©è†œ)é…ç½® ğŸ¯

### ä½¿ç”¨åœºæ™¯

**åŒ»å­¦å½±åƒå±€éƒ¨é…å‡†** - ä»…å¯¹æ„Ÿå…´è¶£åŒºåŸŸ(ROI)è¿›è¡Œé…å‡†:
- **TMJé…å‡†**: CBCTå…¨å¤´ + MRIå±€éƒ¨å…³èŠ‚åˆ‡ç‰‡
- **è„Šæ¤é…å‡†**: å¿½ç•¥å‘¨å›´è½¯ç»„ç»‡,ä»…é…å‡†éª¨ç»“æ„
- **è‚¿ç˜¤é…å‡†**: ä»…å…³æ³¨ç—…ç¶åŒºåŸŸ

### å‘½ä»¤è¡Œç”¨æ³•

```powershell
# ä½¿ç”¨å›ºå®šå›¾åƒæ©è†œ
.\build\bin\Release\MIRegistration.exe `
    --fixed-mask "E:\masks\roi_mask.nrrd" `
    --config "config\Rigid.json" `
    --initial "coarse.h5" `
    "fixed.nrrd" "moving.nrrd" "output\"

# æˆ–ä½¿ç”¨æµ‹è¯•è„šæœ¬
.\test_registration.ps1 `
    fixed.nrrd moving.nrrd output\ `
    -config config\Rigid.json `
    -initial coarse.h5 `
    -fixedMask roi_mask.nrrd
```

### Maskæ–‡ä»¶è¦æ±‚

**æ ¼å¼**: .nrrd æˆ– .nii.gz LabelMapVolume

**æ•°å€¼è§„èŒƒ**:
- **ROI (æ„Ÿå…´è¶£åŒºåŸŸ)**: å€¼ > 0 (é€šå¸¸ä¸º1)
- **èƒŒæ™¯ (å¿½ç•¥åŒºåŸŸ)**: å€¼ = 0

**ç”Ÿæˆå·¥å…·**: 3D Slicer
1. åŠ è½½å›ºå®šå›¾åƒ (Fixed Image)
2. ä½¿ç”¨ Segment Editor å‹¾ç”»ROI
3. Export â†’ LabelMapVolume
4. ä¿å­˜ä¸º .nrrd æ ¼å¼

### é‡‡æ ·ç­–ç•¥è°ƒæ•´ âš ï¸

**é‡è¦**: Maskä¼šè‡ªåŠ¨è°ƒæ•´é‡‡æ ·æ•°é‡è®¡ç®—æ–¹å¼

#### æ— Maskæƒ…å†µ (å…¨å›¾é…å‡†)
```
é‡‡æ ·æ•° = å…¨å›¾åƒä½“ç´ æ•° Ã— samplingPercentage
ä¾‹: 153,412,308 Ã— 10% = 15,341,231 æ ·æœ¬
```

#### æœ‰Maskæƒ…å†µ (å±€éƒ¨é…å‡†) âœ…
```
é‡‡æ ·æ•° = Maskå†…ä½“ç´ æ•° Ã— samplingPercentage
ä¾‹: 24,239,738 Ã— 10% = 2,423,974 æ ·æœ¬
```

**å…³é”®ä¿®å¤ (2025-12-10)**:
- **ä¹‹å‰çš„BUG**: é‡‡æ ·æ•°åŸºäºå…¨å›¾åƒè®¡ç®—,å¯¼è‡´Maskå†…è¿‡åº¦é‡‡æ ·
  ```
  é”™è¯¯: 15,341,231 / 24,239,738 = 63.3% å®é™…é‡‡æ ·ç‡ (è¿‡å¯†!)
  ```
- **ä¿®å¤å**: é‡‡æ ·æ•°æ­£ç¡®åŸºäºMaskåŒºåŸŸ
  ```
  æ­£ç¡®: 2,423,974 / 24,239,738 = 10% å®é™…é‡‡æ ·ç‡ âœ“
  ```

### æ¨èé…ç½®å‚æ•°

#### åœºæ™¯1: å°ROI (< 20%å…¨å›¾)
```json
{
    "samplingPercentage": 0.15,
    "numberOfHistogramBins": 24,
    "learningRate": [1.5, 0.8, 0.4, 0.1, 0.05]
}
```
- é™ä½é‡‡æ ·ç‡é¿å…è¿‡æ‹Ÿåˆ
- å‡å°‘binsé€‚åº”è¾ƒå°æ•°æ®é‡

#### åœºæ™¯2: ä¸­ç­‰ROI (20-50%å…¨å›¾)
```json
{
    "samplingPercentage": 0.20,
    "numberOfHistogramBins": 32,
    "learningRate": [2.0, 1.0, 0.5, 0.1, 0.05]
}
```
- æ ‡å‡†é…ç½®å³å¯

#### åœºæ™¯3: å¤§ROI (> 50%å…¨å›¾)
```json
{
    "samplingPercentage": 0.25,
    "numberOfHistogramBins": 32,
    "learningRate": [2.0, 1.0, 0.5, 0.1, 0.05]
}
```
- ä¸å…¨å›¾é…å‡†å‚æ•°ç›¸åŒ

### è¾“å‡ºä¿¡æ¯è§£è¯»

#### æ— Maskæ—¶ (å…¨å›¾é…å‡†)
```
Using 38353077 samples (25.0% of total voxels)
```
- æ˜¾ç¤ºé‡‡æ ·æ€»æ•°å’Œå å…¨å›¾çš„ç™¾åˆ†æ¯”

#### æœ‰Maskæ—¶ (å±€éƒ¨é…å‡†)
```
[Fixed Mask] Loaded: E:\test5\Fixed_ROI_right_Mask.nrrd
  Mask coverage: 24239738 / 153412308 voxels (15.8%)
[Metric] Mask-aware sampling: 24239738 voxels in mask, 2423974 samples (10.0% of mask)
Using 2423974 samples (10.0% of mask region, 24239738 voxels in mask)
```

**å…³é”®ä¿¡æ¯**:
- **Mask coverage**: ROIå å…¨å›¾åƒç™¾åˆ†æ¯” (15.8%)
- **Mask-aware sampling**: Metricå†…éƒ¨ç»Ÿè®¡ä¿¡æ¯,ç¡®è®¤é‡‡æ ·åŸºäºMaskåŒºåŸŸ
- **Using ... samples**: æœ€ç»ˆä½¿ç”¨çš„é‡‡æ ·æ•°å’Œé‡‡æ ·ç‡
  - `10.0% of mask region` - é‡‡æ ·ç™¾åˆ†æ¯”æ˜¯ç›¸å¯¹MaskåŒºåŸŸ,ä¸æ˜¯å…¨å›¾
  - `24239738 voxels in mask` - MaskåŒºåŸŸæ€»ä½“ç´ æ•°

### æ€§èƒ½ä¸ç²¾åº¦æƒè¡¡

| Maskå¤§å° | è®¡ç®—æ—¶é—´ | MIå€¼èŒƒå›´ | å»ºè®®é‡‡æ ·ç‡ |
|---------|---------|---------|----------|
| < 10%   | æå¿« (10-20s) | å¯èƒ½åä½ | 15-20% |
| 10-30%  | å¿«é€Ÿ (30-50s) | æ­£å¸¸ | 10-15% |
| 30-60%  | ä¸­ç­‰ (50-80s) | æ­£å¸¸ | 10-20% |
| > 60%   | è¾ƒæ…¢ (80s+)   | æ­£å¸¸ | 20-25% |

**æ³¨æ„äº‹é¡¹**:
- MIå€¼ç»å¯¹å¤§å°åœ¨Maské…å‡†ä¸­æ„ä¹‰ä¸å¤§,å…³æ³¨è¿­ä»£è¶‹åŠ¿
- Maskè¶Šå°,MIç»Ÿè®¡ç¨³å®šæ€§è¶Šå·®,å¯èƒ½éœ€è¦æ›´å¤šæ ·æœ¬
- è¿‡å°çš„ROI (<5%)å¯èƒ½å¯¼è‡´ä¼˜åŒ–ä¸ç¨³å®š

---

**æç¤º**: å»ºè®®ä¿å­˜æ¯æ¬¡å®éªŒçš„å‚æ•°å’Œç»“æœ,å»ºç«‹è‡ªå·±çš„å‚æ•°æ•°æ®åº“ã€‚
